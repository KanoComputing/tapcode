<link rel="import" href="../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../style/kano-mobile-shared-styles.html">

<dom-module id="km-editable-code-label">

  <template>

      <style is="custom-style" include="kano-mobile-shared-styles">

        :host {
            display: flex;
            flex-direction: row;
        }

        :host([active]) .selected{
            color: #000; 
            background-color: #fff;
        }

        .line {
            margin-bottom: 4px;
            display: flex;
            flex-direction: row;
        }


        .keyword {
            color: pink;
        }

        .parameter {
            color: purple;
        }

        [hidden] {
            display: none !important;
        }


      </style>
      <!-- shadow DOM-->
      <template id="line-repeater" is="dom-repeat" items="{{statement.lines}}" as="line" index-as="line_no">
          <div class="line">
              <template id="segment-repeater" is="dom-repeat" items="{{line.segments}}" as="segment" index-as="segment_no" on-tap="_selectParamToEdit">
                  <div class$="[[calculateSegmentClass(segment.type, currentLine, currentSegment, line_no, segment_no)]]">[[segment.value]]</div>
              </template>
          </div>
      </template>
  </template>

  <script>
  class KmEditableCodeLabel extends Polymer.GestureEventListeners(Polymer.Element) {
      static get is() {
        return 'km-editable-code-label';
      }

      static get properties() {
        return {
          statement: {
              type: Object,
              value: () => {
                  return {};
              }
          },
          selectedParamIndex: {
              type: Number,
              notify: true
          },
          active: {
              type: Boolean,
              reflectToAttribute: true,
              value: false
          },
          highlightTree: {
              type: Array
          }
        }
      }

      constructor() {
          super();
      }

      //Pseudo code
      // if (if it's a value) {
      //   highlight it;
      // } else if (it's an array, select the block and ask for highlight) {
      //     selectedBlock
      // }

      connectedCallback () {
      }

      calculateSegmentClass (type) {
          return `segment ${type}`;
      }


      _computeParamClass (selectedParamIndex, index) {
          if (selectedParamIndex === index) {
              return 'selected';
          }
      }

      _executeEdit (newValue) {
        this.selectedParamIndex = 0;
        this.set(`block.parameters.${this.selectedParamIndex}.value`, newValue);
      }

      _isLastParameter (index) {
          return (index === (this.block.parameters.length - 1));
      }

      _selectToReplace (e) {

      }

      _selectParamToEdit (e) {
        // Read the editable parameter value and data type
        let item = e.model && e.model.item,
            value = item && item.value,
            type = item && item.type;

        // Store the edited parameter index
        this.selectedParamIndex = e.model && e.model.index;
        this.dispatchEvent(
            new CustomEvent('edit-request', {
                bubbles: true,
                composed: true,
                detail: {
                    value: value,
                    type: type
                }

            })
        );
      }

    }

    customElements.define(KmEditableCodeLabel.is, KmEditableCodeLabel);
  </script>

</dom-module>

