<link rel="import" href="./bower_components/polymer/polymer-element.html">
<link rel="import" href="./bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="./elements/km-code-editor/km-code-editor.html">
<link rel="import" href="./elements/km-softkeys/km-softkeys.html">

<dom-module id="tap-code-editor-view">

    <template>
  
      <style is="custom-style" include="iron-flex iron-flex-alignment">
  
        :host {
            display: block;
            height: 100%;
            width: 100%;
            box-sizing: border-box;
            background-color: #33393d;
            color: #fff;
            font-size: 18px;
            font-family: monospace;
            font-weight: bold;
        }

        .topbar {
            background-color: #33393d;
            padding: 0 14px;
        }

        #kano-logo {
            height: 26px;
            padding: 14px 0 10px;
        }

        .editor-and-canvas {
            height: 55vh;
            position: relative;
            top: 0;
            left: 0;
        }

        .controls {
            height: calc(45vh - 54px);
        }

        #editor {
            display: block;
            width: 100%;
            position: absolute;
            top: 0;
            left: 0;
            color: #fff;
            font-size: 18px;
            overflow: scroll;
            box-sizing: border-box;
            padding: 20px;
            background: transparent;
        }

        #canvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .clear-and-refresh {
            position: absolute;
            top: 32px;
            right: 32px;
        }

        .clear-and-refresh>div {
            display: inline-block;
            cursor: pointer;
            opacity: 0.5;
            transition: opacity 0.3s ease-in;
        }

        .clear-and-refresh>div:first-of-type {
            margin-right: 8px;
        }

        .clear-and-refresh>div:hover {
            opacity: 1;
        }

        .left-and-right-arrow {
            position: absolute;
            bottom: 32px;
            right: 32px;
            height: 40px;
            width: 100px;
        }

        .arrow {
            display: inline-block;
            cursor: pointer;
            background-color: #33393d;
            padding: 10px 14px;
        }

        .arrow > img {
            width: 12px;
            margin: 0;
        }

        #left-arrow {
            transform: rotate(180deg);
        }
  
        .code-line {
            min-height: 26px;
        }

        #number-input, #color-input, #toolbox {
        }

        #toolbox {
            padding: 24px 16px 16px;
            overflow: scroll;
            box-sizing: border-box;
            position: relative;
        }

        .toolbox-bar {
            width: 100%;
            /*height: 5vh;*/
            background-color: #33393d;
            border-bottom: 1px solid #2b3035;
            padding: 0 16px;
            flex-shrink: 0;
        }

        .toolbox-tab {
            display: inline-block;
            padding: 16px;
            text-align: center;
            color: #ffffff;
            margin-right: 16px;
            font-family: monospace;
        }

        .toolbox-tab.selected {
            text-decoration: underline;
        }

        .menu-selected {
            text-decoration: underline;
        }

        .toolbox-item {
            background-color: #23272b;
            color: #fff;
            border-radius: 3px;
            font-family: monospace;
            font-weight: bold;
            cursor: pointer;
            padding: 16px;
            margin: 0 8px 24px 0;
        }

        [disabled] {
            opacity: 0.5;
            pointer-events: none;
        }

        [hidden] {
            display: none !important;
        }
  
      </style>
      
      <div class="topbar">
          <img id="kano-logo" src="assets/kano.svg">
      </div>
      <div class="editor-and-canvas">
          <canvas id="canvas" width="400" height="400"></canvas>
          <km-code-editor id="editor" on-edit-request="_onEditRequest" edited-value="{{editedValue}}" on-run-code="runCode"></km-code-editor>
  
          <div class="clear-and-refresh">
              <div on-tap="clearEditor">clear</div>
              <div on-tap="resetCanvas">refresh</div>
          </div>
          <div class="left-and-right-arrow">
              <div class="arrow" on-tap="_moveLeft">
                  <img id="left-arrow" src="assets/arrow.svg"></img>
              </div>
              <div class="arrow" on-tap="_moveRight">
                  <img src="assets/arrow.svg"></img>
              </div>
          </div>
  
      </div>
      <div class="controls layout vertical">
          <div class="toolbox-bar layout horizontal center" hidden$="[[!_isEqual(inputType, 'newCode')]]">
              <div class$="[[_computeTabClass(activeTab, 'drawing')]]" data-value="drawing" on-tap="_selectMenuTab">drawing</div>
              <div class$="[[_computeTabClass(activeTab, 'style')]]" data-value="style" on-tap="_selectMenuTab">style</div>
              <div class$="[[_computeTabClass(activeTab, 'control')]]" data-value="control" on-tap="_selectMenuTab">control</div>
          </div>
          <div class="toolbox-bar layout horizontal center" hidden$="[[_isEqual(inputType, 'newCode')]]">
              <div class$="[[_computeTabClass(activeTab, 'expressions')]]" data-value="expressions" on-tap="_selectMenuTab">code</div>
              <div class$="[[_computeTabClass(activeTab, inputType)]]" data-value$="[[inputType]]" on-tap="_selectMenuTab">[[inputType]]</div>
          </div>
          <div class="toolbox-bar layout horizontal center" hidden$="[[!_needNumberControl(activeTab, showNumberControl)]]">
              <div class="toolbox-tab flex" on-tap="_toggleOperator" disabled$="[[!needOperator]]">[[operator]]</div>
              <div class="toolbox-tab flex" on-tap="spliceValue" disabled$="[[!needNumberDelete]]"><-</div>
          </div>
          <km-softkeys id="number-input" class="flex" hidden$="[[!_isEqual(activeTab, 'number')]]" on-key-tapped="_processInput"></km-softkeys>
          <km-softkeys id="color-input" class="flex" keys="[[colorKeys]]" hidden$="[[!_isEqual(activeTab, 'color')]]" on-key-tapped="_processInput"></km-softkeys>
          <div id="toolbox" class=" flex layout horizontal start start-aligned wrap" hidden$="[[!_needCodeTray(inputType, activeTab)]]">
              <template id="menu-item-repeater" is="dom-repeat" items="{{statements}}" as="statement" filter="_filterMenuItem">
                  <div class="toolbox-item" on-tap="_addStatement">
                      <template id="line-repeater" is="dom-repeat" items="{{statement.lines}}" as="line">
                          <div class="horizontal layout">
                              <template id="segment-repeater" is="dom-repeat" items="{{line.segments}}" as="segment">
                                  <div>[[segment.value]]</div>
                              </template>
                          </div>
                      </template>
                  </div>
              </template>
          </div>
      </div>
    </template>

    <script>

      class TapCodeEditorView extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() { 
            return 'tap-code-editor-view';
        }
  
        static get properties() {
            return {
                activeTab: {
                    type: String,
                    value: 'drawing'
                },
                inputType: {
                    type: String,
                    value: 'newCode'
                },
                colorKeys: {
                    type: Array,
                    value: () => ['#ff0000','#00ff00','#0000ff','#ffff00','#00ffff','#ff00ff','#ffffff','#000000','#7f7f7f']
                },
                operator: {
                    type: String,
                    value: "-"
                },
                showNumberControl: {
                    type: Boolean,
                    value: false
                },
                editedValue: {
                    type: String,
                    observer: '_onEditedValueChanged'
                },
                needNumberDelete: {
                    type: Boolean,
                    value: false
                },
                needOperator: {
                    type: Boolean,
                    value: false
                }
            }
        }
  
        constructor () {
            super();
            Polymer.RenderStatus.afterNextRender(this, function() {
                this.processApiStatements(window.statements);
            });
        }

        runCode (e) {
            this.taptypeApi.runCode(e);
        }

        _addMinus () {
            this.$.editor.lines('-');
        }

        processApiStatements (statements) {
            let opts = {};
            opts.statements = window.statements;
            opts.ctx = this.$.canvas.getContext("2d");
            opts.canvas = this.$.canvas;

            this.taptypeApi = new window.TaptypeApi(opts);
            this.set('statements', this.taptypeApi.statements);
            setTimeout(() => {
                this.$.editor.addCode(this.statements[0]);
                this.$.editor.moveLine();
                this.$.editor.addCode(this.statements[3]);
            }, 100);
        }
  
        ready () {
            super.ready();
            Polymer.RenderStatus.afterNextRender(this, function() {
                resetCanvas();
            });
        }  
  
        _onEditRequest (e) {
            let dataType = e.detail.dataType || e.detail.returns;
            if (dataType) {
                this.inputType = this.activeTab = dataType;
            } else {
                this.inputType = 'newCode';
                this.activeTab = 'drawing';
            }
            this.$['menu-item-repeater'].render();
        }
  
        _addStatement (e) {
            this.$.editor.addCode(e.model.statement);
        }
  
        _processInput (e) {
            if (e.detail === 'done') {
                this.$.editor.moveCursor();
            } else {
                this.$.editor.processInput(e.detail);
            }
        }
  
        _selectMenuTab (e) {
            this.activeTab = e.currentTarget.getAttribute('data-value');
            this.$['menu-item-repeater'].render();
        }
  
        _filterMenuItem (item) {
            if (this.inputType === 'newCode') {
                return item.type === this.activeTab;
            } else {
                return item.returns === this.inputType;
            }
        }
  
        _isEqual (selected, instance) {
            return selected === instance;
        }
  
        _moveLeft () {
            this.$.editor.moveCursor(-1);
        }
  
        _moveRight () {
            this.$.editor.moveCursor(1);
        }

        _toggleOperator () {
            this.$.editor.toggleOperator();
            this.operator = this.operator === '-' ? '+' : '-';
        }
  
        clearEditor () {
            this.$.editor.reset();
        }

        resetCanvas () {
            resetCanvas();
            // gate = false;
        }

        spliceValue () {
            //TODO refactor
            let ed = this.$.editor;
            let currentValue = ed.get(`lines.${ed.currentLine}.segments.${ed.currentSegment}.value`);
            ed.set(`lines.${ed.currentLine}.segments.${ed.currentSegment}.value`, currentValue.slice(0, -1));
            this.editedValue = currentValue.slice(0, -1);
        }

        _needNumberControl (activeTab, showNumberControl) {
            return activeTab === 'number' && showNumberControl;
        }

        _onEditedValueChanged (value) {
            this.showNumberControl = !isNaN(parseFloat(value));
            if (!isNaN(parseFloat(value))) {
                this.showNumberControl = true;
                this.needNumberDelete = value.length > 1;
                this.needOperator = value !== '0';
                this.operator = value < 0 ? '+' : '-' 
            }
        }

        _needCodeTray (inputType, activeTab) {
            return (inputType === 'newCode' || activeTab === 'expressions');
        }

        _computeTabClass (activeTab, instance) {
            return activeTab === instance ? 'toolbox-tab flex selected' : 'toolbox-tab flex';
        }

      }
      customElements.define(TapCodeEditorView.is, TapCodeEditorView);
    </script>

</dom-module>

