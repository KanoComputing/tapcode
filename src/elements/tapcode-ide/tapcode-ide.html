<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../../bower_components/kwc-color-picker/kwc-color-picker.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../km-code-editor/km-code-editor.html">
<link rel="import" href="../km-softkeys/km-softkeys.html">
<link rel="import" href="../tapcode-icons.html">

<dom-module id="tapcode-ide">

    <template>
  
        <style is="custom-style" include="iron-flex iron-flex-alignment">
    
            :host {
                display: flex;
                flex-direction: column;
                height: 100%;
                width: 100%;
                box-sizing: border-box;
                background-color: #2b3035;
                color: #fff;
                font-size: 12px;
                font-family: monospace;
                font-weight: bold;
            }

            .code-and-canvas {
                flex: 1 1 55%;
                background: #2b3035;
                position: relative;
                top: 0;
                left: 0;
                overflow: auto;
            }
    
            #toolbox {
                position: relative;
                flex: 1 1 45%;
                background: #33393d;
            }
            
            #code-visibility-btn {
                position: absolute;
                top: -28px;
                width: 72px;
                height: 28px;
                left: calc(50% - 50px);
                z-index: 22;
                border-radius: 3px 3px 0 0;
            }
            
            #code-visibility-btn>iron-icon {
                margin: 0 auto;
            }
    
            #editor {
                display: block;
                width: 100%;
                min-height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                color: #fff;
                box-sizing: border-box;
                padding: 24px 8px 24px 4px;
                background: transparent;
                overflow: auto;
            }
    
            #canvas {
                position: fixed;
                top: 56px;
                left: 0;
                width: 100vw;
                border-radius: 6px;
                /*border: 1px dashed white;*/
            }
    
            .clear-and-refresh {
                position: absolute;
                top: 24px;
                right: 4px;
            }
    
            .clear-and-refresh>div {
                display: inline-block;
                cursor: pointer;
                opacity: 0.5;
                transition: opacity 0.3s ease-in;
            }
    
            .clear-and-refresh>div:hover {
                opacity: 1;
            }
            
            #refresh-tap-area,
            #delete-tap-area,
            #fullscreen-tap-area,
            .arrow-area {
                height: 48px;
                width: 48px;
            }
    
            .left-and-right-arrow {
                position: absolute;
                bottom: 8px;
                right: 8px;
            }
    
            .arrow-area {
                display: inline-block;
                cursor: pointer;
                background-color: #33393d;
            }
    
            .arrow-area > img {
                display: block;
                height: 18px;
                margin: 15px auto;
            }
    
            #left-arrow {
                transform: rotate(180deg);
            }
      
            .code-line {
                min-height: 26px;
            }

            kwc-color-picker#color-input {
                --kwc-color-picker-margin: 16px;
                margin: 0 auto;
                --kwc-color-picker-size: 32px;
            }        
    
            #snippet-library {
                position: relative;
                overflow: auto;
                box-sizing: border-box;
                padding: 24px 16px 16px;
            }
    
            .toolbox-bar,
            .softkey-menu {
                width: 100%;
                font-size: 14px;
                background-color: #33393d;
                border-bottom: 1px solid #2b3035;
                box-sizing: border-box;
                flex-shrink: 0;
                padding: 0 16px;
            }
    
            .toolbox-bar>div,
            .softkey-menu>div {
                display: inline-block;
                text-align: center;
                color: #ffffff;
                font-family: monospace;
            }
            
            .toolbox-bar>div {
                padding: 20px 0 18px;
            }
            
            .softkey-menu>div {
                padding: 14px 0 12px;
            }
            
            .softkey-menu iron-icon {
                --iron-icon-width: 16px;
                --iron-icon-height: 16px;
            }
    
            .toolbox-tab.selected {
                text-decoration: underline;
            }
    
            .menu-selected {
                text-decoration: underline;
            }
    
            .toolbox-item {
                background-color: #23272b;
                color: #fff;
                border-radius: 3px;
                font-family: monospace;
                font-weight: bold;
                cursor: pointer;
                padding: 10px 10px 8px;
                margin: 0 8px 16px 0;
            }
    
            .whitespace:before {
                content: '\00a0';
            }
    
            .comma:after {
                content: '\00a0';
            }
    
            [disabled] {
                opacity: 0.5;
                pointer-events: none;
            }
    
            [hidden] {
                display: none !important;
            }
      
        </style>
        
        <div class="code-and-canvas">
            <canvas id="canvas" width="1000" height="1000"></canvas>
            <km-code-editor id="editor" on-edit-request="_onEditRequest" edited-value="{{editedValue}}" on-run-code="runCode"></km-code-editor>
    
            <div class="clear-and-refresh vertical layout justified">
                <div id="refresh-tap-area" class="layout horizontal center-center" on-tap="resetAndRun">
                    <iron-icon id="menu-icon" icon="tapcode:refresh"></iron-icon>
                </div>
                <div id="delete-tap-area" class="layout horizontal center-center" on-tap="clearCode">
                    <iron-icon id="delete-icon" icon="tapcode:delete"></iron-icon>
                </div>
                <div id="fullscreen-tap-area" class="layout horizontal center-center" on-tap="onTrack">
                    <iron-icon icon="tapcode:fullscreen"></iron-icon>
                </div>
            </div>
            <div class="left-and-right-arrow">
                <div class="arrow-area" on-tap="_moveLeft">
                    <img id="left-arrow" src="assets/arrow.svg"></img>
                </div>
                <div class="arrow-area" on-tap="_moveRight">
                    <img src="assets/arrow.svg"></img>
                </div>
            </div>
    
        </div>
        <div id="toolbox" class="flex vertical layout">
            <div id="code-visibility-btn">
            </div>
            <div class="toolbox-bar layout horizontal center" hidden$="[[!_isEqual(inputType, 'newCode')]]">
                <div class$="[[_computeTabClass(activeTab, 'drawing')]]" data-value="drawing" on-tap="_selectMenuTab">drawing</div>
                <div class$="[[_computeTabClass(activeTab, 'style')]]" data-value="style" on-tap="_selectMenuTab">style</div>
                <div class$="[[_computeTabClass(activeTab, 'control')]]" data-value="control" on-tap="_selectMenuTab">control</div>
            </div>
            <div class="softkey-menu layout horizontal center" hidden$="[[_isEqual(inputType, 'newCode')]]">
                <div class$="[[_computeTabClass(activeTab, 'expressions')]]" data-value="expressions" on-tap="_selectMenuTab">code</div>
                <div class$="[[_computeTabClass(activeTab, inputType)]]" data-value$="[[inputType]]" on-tap="_selectMenuTab">[[inputType]]</div>
            </div>
            <div class="softkey-menu layout horizontal center" hidden$="[[!_needNumberControl(activeTab, showNumberControl)]]">
                <div class="flex" on-tap="_toggleOperator" disabled$="[[!needOperator]]">
                    <iron-icon icon="tapcode:add" hidden$="[[!_isEqual(operator, 'plus')]]"></iron-icon>
                    <iron-icon icon="tapcode:remove" hidden$="[[!_isEqual(operator, 'minus')]]"></iron-icon>
                </div>
                <div class="flex" on-tap="spliceValue" disabled$="[[!needNumberDelete]]">
                    <iron-icon icon="tapcode:keyboard-backspace"></iron-icon>
                </div>
            </div>
            <km-softkeys id="number-input" class="flex vertical layout" hidden$="[[!_isEqual(activeTab, 'number')]]" on-key-tapped="_processInput"></km-softkeys>
            <kwc-color-picker id="color-input" class="flex" hidden$="[[!_isEqual(activeTab, 'color')]]" row-size="5" on-change="_processInput"></kwc-color-picker>
            <div id="snippet-library" class="flex layout horizontal start start-aligned wrap" hidden$="[[!_needCodeTray(inputType,   activeTab)]]">
                <template id="menu-item-repeater" is="dom-repeat" items="{{statements}}" as="statement" filter="_filterMenuItem">
                    <div class="toolbox-item horizontal layout" on-tap="_addStatement">
                        <template id="line-repeater" is="dom-repeat" items="{{statement.lines}}" as="line">
                            <div class="horizontal layout">
                                <template id="segment-repeater" is="dom-repeat" items="{{line.segments}}" as="segment">
                                    <div class$="[[_calculateSegmentClass(segment.type)]]">[[segment.value]]</div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <script>

      class TapcodeIde extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() { 
            return 'tapcode-ide';
        }
  
        static get properties() {
            return {
                activeTab: {
                    type: String,
                    value: 'drawing'
                },
                inputType: {
                    type: String,
                    value: 'newCode'
                },
                colorKeys: {
                    type: Array,
                    value: () => ['#ff0000','#00ff00','#0000ff','#ffff00','#00ffff','#ff00ff','#ffffff','#000000','#7f7f7f']
                },
                operator: {
                    type: String,
                    value: "minus"
                },
                showNumberControl: {
                    type: Boolean,
                    value: false
                },
                editedValue: {
                    type: String,
                    observer: '_onEditedValueChanged'
                },
                needNumberDelete: {
                    type: Boolean,
                    value: false
                },
                needOperator: {
                    type: Boolean,
                    value: false
                },
                doneArray: {
                    type: Array,
                    value: () => []
                }
            }
        }

        constructor () {
            super();
            Polymer.RenderStatus.afterNextRender(this, () => {
                this.processApiStatements(Kano.TapCode.api);
                //FIXME
                canvas = this.$.canvas;
                this.onTrack = this.onTrack.bind(this);
                // Polymer.Gestures.addListener(this.$['code-visibility-btn'], 'tap', this.onTrack);
            });
        }
        
        connectedCallback () {
            this._onResize = this._onResize.bind(this);
            this._onResize();
            window.addEventListener('resize', this._onResize);
            
        }
        
        disconnectedCallback () {
            window.removeEventListener('resize', this._onResize);
            // Polymer.Gestures.removeListener(this.$['code-visibility-btn'], 'tap', this.onTrack);
        }
        
        onTrack (event) {
            var elArray = ['toolbox', 'delete-tap-area', 'refresh-tap-area', 'editor'];
            elArray.forEach(el => this.translateOffscreen(this.$[el]));
        }
        
        translateOffscreen (el) {
            if (this.doneArray.indexOf(el) !== -1) {
                return;
            }
            
            let rect = el.getBoundingClientRect();
            let windowWidth = Math.max(document.documentElement.clientWidth, window.innerWidth || 0);
            let windowHeight = Math.max(document.documentElement.clientHeight, window.innerHieght || 0);
            let offset = {
                top: rect.top + rect.height,
                right: windowWidth - rect.right + rect.width,
                bottom: windowHeight - rect.bottom + rect.height,
                left: rect.left + rect.width
            }
            let arr = [
                {
                    direction: 'top',
                    value: offset.top,
                    translate: `0, -${offset.top}px`,
                }, {
                    direction: 'right',
                    value: offset.right,
                    translate: `${offset.right}px, 0`
                }, {
                    direction: 'bottom',
                    value: offset.bottom,
                    translate: `0, ${offset.bottom}px`
                }, {
                    direction: 'left',
                    value: offset.left,
                    translate: `-${offset.left}px, 0`
                }
            ]
            let direction = arr.sort((a, b) => a.value - b.value)[0];
            console.log('fof', direction);
            
            el.style.transition = 'all 0.3s ease';
            el.style['box-sizing'] = 'border-box';
            // el.style.display = 'none';
            // toMove = direction.translate.replace('$', direction.value);
            console.log('yos', direction);
            
            setTimeout(()=> {
                el.style.transform = `translate(${direction.translate})`;
                console.log("JJJJ", `translate(${direction.translate})`)
                this.doneArray.push(el);
            });
            
        }

        runCode (e) {
            if (this.CanvasDraw) {
                this.resetCanvas();
                this.CanvasDraw.runCode(e.detail);
            }
        }

        processApiStatements (statements) {
            let opts = {};
            opts.statements = Kano.TapCode.api;
            opts.ctx = this.$.canvas.getContext("2d");
            opts.canvas = this.$.canvas;
            let canvasOpts = {};
            canvasOpts.ctx = this.$.canvas.getContext("2d");
            canvasOpts.canvas = this.$.canvas;
            this.CanvasDraw = new Kano.CanvasDraw(canvasOpts);
            this.prism = new Kano.Prism(opts);
            this.set('statements', this.prism.statements);
            setTimeout(() => {
                // this.$.editor.addCode(this.statements[2]);
                // this.$.editor.moveLine();
                // this.$.editor.addCode(this.statements[3]);
            }, 100);
        }
  
        ready () {
            super.ready();
            Polymer.RenderStatus.afterNextRender(this, function() {
                this.resetCanvas();
            });
        }  
  
        _onEditRequest (e) {
            let dataType = e.detail.dataType || e.detail.returns;
            if (dataType) {
                this.inputType = this.activeTab = dataType;
            } else {
                this.inputType = 'newCode';
                this.activeTab = 'drawing';
            }
            this.$['menu-item-repeater'].render();
        }
  
        _addStatement (e) {
            this.$.editor.addCode(e.model.statement);
        }
  
        _processInput (e) {
            if (e.detail === 'done') {
                this.$.editor.concludeEdit();
            } else {
                this.$.editor.processInput(e.detail);
            }
        }
  
        _selectMenuTab (e) {
            this.activeTab = e.currentTarget.getAttribute('data-value');
            this.$['menu-item-repeater'].render();
        }
  
        _filterMenuItem (item) {
            if (this.inputType === 'newCode') {
                return item.type === this.activeTab;
            } else {
                return item.returns === this.inputType;
            }
        }
  
        _isEqual (selected, instance) {
            this.$['color-input'].notifyResize();
            return selected === instance;
        }

        exportCode () {
            let a = document.createElement('a'),
                file = new Blob([JSON.stringify(this.$.editor.lines)], {type: 'application/taptype'}),
                url = URL.createObjectURL(file);
            document.body.appendChild(a);
            a.download = 'my-code.tapcode';
            a.href = url;
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }

        _importCode () {
            this.fileInput = document.createElement('input');
            this.fileInput.setAttribute('type', 'file');
            this.fileInput.style.display = 'none';
            this.fileInput.addEventListener('change', evt => {
                let f = evt.target.files[0];
                if (f) {
                    let r = new FileReader();
                    r.onload = (e) => {
                        // Read the mode
                        let code = JSON.parse(e.target.result);
                        this.$.editor.set('lines', code);
                    };
                    r.readAsText(f);
                    document.body.removeChild(this.fileInput);
                }
            });
            document.body.appendChild(this.fileInput);
            this.fileInput.click();
        }
  
        _moveLeft () {
            this.$.editor.moveCursor(-1);
        }
  
        _moveRight () {
            this.$.editor.moveCursor(1);
        }

        _toggleOperator () {
            this.$.editor.toggleOperator();
            this.operator = this.operator === 'minus' ? 'plus' : 'minus';
        }
  
        clearCode () {
            if (Kano.TapCode.loop) {
                window.cancelAnimationFrame(Kano.TapCode.loop);
                Kano.TapCode.loop = null;
            }
            this.$.editor.reset();
            this.resetCanvas();
        }
        
        resetAndRun () {
            
            // this.resetCanvas();
            
            this.$.editor.runCode();
        }

        resetCanvas () {
            let codeArea =  this._getEditorDimensions(),
                size;
            if (codeArea.height >= codeArea.width) {
                size = codeArea.width;
            } else {
                size = codeArea.height;
            }
            resetCanvas(size);
        }

        spliceValue () {
            //TODO refactor
            let ed = this.$.editor;
            let currentValue = ed.get(`lines.${ed.currentLine}.segments.${ed.currentSegment}.value`);
            console.log('cs', currentValue.length)
            if (currentValue.length > 1) {
                ed.set(`lines.${ed.currentLine}.segments.${ed.currentSegment}.value`, currentValue.slice(0, -1));
                this.editedValue = currentValue.slice(0, -1);
            } else {
                ed.set(`lines.${ed.currentLine}.segments.${ed.currentSegment}.value`, 0);
            }
        }

        _needNumberControl (activeTab, showNumberControl) {
            return activeTab === 'number' && showNumberControl;
        }

        _onEditedValueChanged (value) {
            this.showNumberControl = !isNaN(parseFloat(value));
            if (!isNaN(parseFloat(value))) {
                this.showNumberControl = true;
                this.needNumberDelete = value.length > 0;
                this.needOperator = value !== '0';
                this.operator = value < 0 ? 'plus' : 'minus' 
            }
        }

        _needCodeTray (inputType, activeTab) {
            return (inputType === 'newCode' || activeTab === 'expressions');
        }

        _computeTabClass (activeTab, instance) {
            return activeTab === instance ? 'toolbox-tab flex selected' : 'toolbox-tab flex';
        }

        _calculateSegmentClass (type) {
            return `segment ${type}`;
        }
        
        _getEditorDimensions () {
            return {
                height: this.shadowRoot.querySelector('.code-and-canvas').getBoundingClientRect().height,   
                width: this.shadowRoot.querySelector('.code-and-canvas').getBoundingClientRect().width
            }
        }
        
        _onResize () {
            // TODO DEBOUNCE
            let codeArea =  this._getEditorDimensions(),
                size;
            
            // Portrait
            if (codeArea.height >= codeArea.width) {
                size = codeArea.width;
                
                this.$.canvas.style.width = this.$.canvas.style.height = `${size}px`
                // this.$.canvas.width = this.$.canvas.height = size;
                this.$.canvas.style.top = `${56 + codeArea.height / 2 - (size / 2)}px`;
                this.$.canvas.style.left = `0`;
                
            } else {
                size = codeArea.height;
                this.$.canvas.style.width = this.$.canvas.style.height = `${size}px`
                this.$.canvas.style.top = '56px';
                this.$.canvas.style.left = `${codeArea.width / 2 - (size / 2)}px`;
                // this.$.canvas.width = this.$.canvas.height = size;
            }
            
            window.cursorX = Math.round(size / 2);
            window.cursorY = Math.round(size / 2);
            console.log('oksdoksodkoskods', window.cursorX);
        }

      }
      customElements.define(TapcodeIde.is, TapcodeIde);
    </script>

</dom-module>

