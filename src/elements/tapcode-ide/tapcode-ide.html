<link rel="import" href="../../../bower_components/polymer/polymer-element.html">
<link rel="import" href="../../../bower_components/iron-flex-layout/iron-flex-layout-classes.html">
<link rel="import" href="../../../bower_components/polymer/lib/mixins/gesture-event-listeners.html">
<link rel="import" href="../../../bower_components/kwc-color-picker/kwc-color-picker.html">
<link rel="import" href="../../../bower_components/iron-resizable-behavior/iron-resizable-behavior.html">
<link rel="import" href="../../scripts/kano-canvas-draw.html">
<link rel="import" href="../../scripts/kano-prism.html">
<link rel="import" href="../../scripts/tapcode-api.html">
<link rel="import" href="../km-code-editor/km-code-editor.html">
<link rel="import" href="../km-softkeys/km-softkeys.html">
<link rel="import" href="../tapcode-icons.html">

<dom-module id="tapcode-ide">
    <template>
        <style include="iron-flex iron-flex-alignment">
    
            :host {
                display: flex;
                flex-direction: column;
                height: 100%;
                width: 100%;
                box-sizing: border-box;
                background-color: #2b3035;
                color: #fff;
                font-size: 12px;
                font-family: monospace;
                font-weight: bold;
            }

            .code-and-canvas {
                flex: 1 1 55%;
                background: #2b3035;
                position: relative;
            }
    
            #toolbox {
                position: relative;
                flex: 1 1 45%;
                background: #33393d;
            }
            
            .to-right,
            .to-bottom,
            .to-left,
            #canvas {
                transition: transform 0.3s;
            }
            
            :host([fullscreen]) .to-right {
                transform: translateX(100%);
            }
            
            :host([fullscreen]) .to-bottom {
                transform: translateY(100%);
            }
            
            :host([fullscreen]) .to-left {
                transform: translateX(-100%);
            }
    
            #editor {
                display: block;
                width: 100%;
                height: 100%;
                position: absolute;
                top: 0;
                left: 0;
                color: #fff;
                box-sizing: border-box;
                padding: 24px 8px 24px 4px;
                background: transparent;
                overflow: auto;
            }
    
            #canvas {
                position: absolute;
                /*we compute and inline top and left properties */
                width: 100vw;
                border-radius: 6px;
            }
    
            .clear-and-refresh {
                position: absolute;
                top: 24px;
                right: 4px;
            }
    
            .clear-and-refresh>div {
                display: inline-block;
                cursor: pointer;
                opacity: 0.5;
                transition: opacity 0.3s ease-in, transform 0.3s;
                z-index: 10;
            }
    
            .clear-and-refresh>div:hover {
                opacity: 1;
            }
            
            #refresh-tap-area,
            #delete-tap-area,
            #fullscreen-tap-area {
                height: 48px;
                width: 48px;
                position: relative;
            }
            
            #fullscreen-tap-area>span {
                position: absolute;
                top: 0;
                left: 0;
                white-space: nowrap;
                line-height: 48px;
                transition: transform 300ms;
                opacity: 0;
                transform: translateX(0);
            }
            
            :host([fullscreen]) #fullscreen-tap-area>span {
                transform: translateX(-60px);
                transition: transform 300ms, opacity 200ms ease 50ms;
                opacity: 1;
            }
            
            .clear-and-refresh iron-icon {
                background: rgba(43, 48, 53, 0.8);
                border-radius: 3px;
            }
    
            .left-and-right-arrow {
                position: absolute;
                bottom: 8px;
                right: 0;
                text-align: right;
                padding-right: 8px;
                z-index: 10;
            }

            .arrow-area {
                height: 48px;
                width: 48px;
                cursor: pointer;
                border-radius: 3px;
                background-color: #33393d;
            }

            .arrow-area:last-child {
                margin-left: 8px;
            }
    
            .arrow-area > img {
                display: block;
                height: 16px;
                margin: 16px auto;
            }
    
            #left-arrow {
                transform: rotate(180deg);
            }
      
            .code-line {
                min-height: 26px;
            }

            kwc-color-picker#color-input {
                --kwc-color-picker-margin: 16px;
                margin: 0 auto;
                --kwc-color-picker-size: 32px;
            }        
    
            #snippet-library {
                position: relative;
                overflow: auto;
                box-sizing: border-box;
                padding: 24px 16px 16px;
            }
    
            .toolbox-bar,
            .softkey-menu {
                width: 100%;
                font-size: 14px;
                background-color: #33393d;
                border-bottom: 1px solid #2b3035;
                box-sizing: border-box;
                flex-shrink: 0;
                padding: 0 16px;
            }
    
            .toolbox-bar>div,
            .softkey-menu>div {
                display: inline-block;
                text-align: center;
                color: #ffffff;
                font-family: monospace;
            }
            
            .toolbox-bar>div {
                padding: 20px 0 18px;
            }
            
            .softkey-menu>div {
                padding: 14px 0 12px;
            }
            
            .softkey-menu iron-icon {
                --iron-icon-width: 16px;
                --iron-icon-height: 16px;
            }
    
            .toolbox-tab.selected {
                text-decoration: underline;
            }
    
            .menu-selected {
                text-decoration: underline;
            }
    
            .toolbox-item {
                background-color: #23272b;
                color: #fff;
                border-radius: 3px;
                font-family: monospace;
                font-weight: bold;
                cursor: pointer;
                padding: 10px 10px 8px;
                margin: 0 8px 16px 0;
            }
    
            .whitespace:before {
                content: '\00a0';
            }
    
            .comma:after {
                content: '\00a0';
            }
    
            [disabled] {
                opacity: 0.5;
                pointer-events: none;
            }
    
            [hidden] {
                display: none !important;
            }
      
        </style>
        
        

        <div class="code-and-canvas">
            <div class="clear-and-refresh vertical layout justified">
                <div id="refresh-tap-area" class="layout horizontal center-center to-right" on-tap="resetAndRun">
                    <iron-icon id="menu-icon" icon="tapcode:refresh"></iron-icon>
                </div>
                <div id="delete-tap-area" class="layout horizontal center-center to-right" on-tap="clearCode" hidden$="[[noDelete]]">
                    <iron-icon id="delete-icon" icon="tapcode:delete"></iron-icon>
                </div>
                <div id="fullscreen-tap-area" class="layout horizontal center-center" on-tap="_toggleFullscreen">
                    <span>show code</span>
                    <iron-icon icon="tapcode:fullscreen"></iron-icon>
                </div>
            </div>
            <div class="left-and-right-arrow to-right horizontal layout">
                <div class="arrow-area" on-tap="_moveLeft">
                    <img id="left-arrow" src="assets/arrow.svg"></img>
                </div>
                <div class="arrow-area" on-tap="_moveRight">
                    <img src="assets/arrow.svg"></img>
                </div>
            </div>
            <canvas id="canvas" width="1000" height="1000"></canvas>
            <km-code-editor id="editor" class="to-left" on-edit-request="_onEditRequest" edited-value="{{editedValue}}" on-run-code="runCode" lines="{{code}}"></km-code-editor>
        </div>

        <div id="toolbox" class="flex vertical layout to-bottom">
            <div class="toolbox-bar layout horizontal center" hidden$="[[!_isEqual(inputType, 'newCode')]]">
                <div class$="[[_computeTabClass(activeTab, 'drawing')]]" data-value="drawing" on-tap="_selectMenuTab">drawing</div>
                <div class$="[[_computeTabClass(activeTab, 'style')]]" data-value="style" on-tap="_selectMenuTab">style</div>
                <div class$="[[_computeTabClass(activeTab, 'control')]]" data-value="control" on-tap="_selectMenuTab">control</div>
            </div>
            <div class="softkey-menu layout horizontal center" hidden$="[[_isEqual(inputType, 'newCode')]]">
                <div class$="[[_computeTabClass(activeTab, 'expressions')]]" data-value="expressions" on-tap="_selectMenuTab">code</div>
                <div class$="[[_computeTabClass(activeTab, inputType)]]" data-value$="[[inputType]]" on-tap="_selectMenuTab">[[inputType]]</div>
            </div>
            <div class="softkey-menu layout horizontal center" hidden$="[[!_needNumberControl(activeTab, showNumberControl)]]">
                <div class="flex" on-tap="_toggleOperator">
                    <iron-icon icon="tapcode:add" hidden$="[[!_isEqual(operator, '+')]]"></iron-icon>
                    <iron-icon icon="tapcode:remove" hidden$="[[!_isEqual(operator, '-')]]"></iron-icon>
                </div>
                <div class="flex" on-tap="spliceValue" disabled$="[[!needNumberDelete]]">
                    <iron-icon icon="tapcode:keyboard-backspace"></iron-icon>
                </div>
            </div>
            <km-softkeys id="number-input" class="flex vertical layout" hidden$="[[!_isEqual(activeTab, 'number')]]" on-key-tapped="_processInput"></km-softkeys>
            <kwc-color-picker id="color-input" class="flex" hidden$="[[!_isEqual(activeTab, 'color')]]" row-size="5" on-change="_processInput"></kwc-color-picker>
            <div id="snippet-library" class="flex layout horizontal start start-aligned wrap" hidden$="[[!_needCodeTray(inputType,   activeTab)]]">
                <template id="menu-item-repeater" is="dom-repeat" items="{{statements}}" as="statement" filter="_filterMenuItem">
                    <div class="toolbox-item horizontal layout" on-tap="_addStatement">
                        <template id="line-repeater" is="dom-repeat" items="{{statement.lines}}" as="line">
                            <div class="horizontal layout">
                                <template id="segment-repeater" is="dom-repeat" items="{{line.segments}}" as="segment">
                                    <div class$="[[_calculateSegmentClass(segment.type)]]">[[segment.value]]</div>
                                </template>
                            </div>
                        </template>
                    </div>
                </template>
            </div>
        </div>
    </template>

    <script>

      class TapcodeIde extends Polymer.GestureEventListeners(Polymer.Element) {
        static get is() { 
            return 'tapcode-ide';
        }
  
        static get properties() {
            return {
                code: {
                    type: Array,
                    notify: true
                },
                fullscreen: {
                    type: Boolean,
                    value: false,
                    notify: true,
                    reflectToAttribute: true
                },
                statements: {
                    type: Array  
                },
                statementWhitelist: {
                    type: Array
                },
                activeTab: {
                    type: String,
                    value: 'drawing'
                },
                inputType: {
                    type: String,
                    value: 'newCode'
                },
                colorKeys: {
                    type: Array,
                    value: () => ['#ff0000','#00ff00','#0000ff','#ffff00','#00ffff','#ff00ff','#ffffff','#000000','#7f7f7f']
                },
                operator: {
                    type: String,
                    value: "-"
                },
                showNumberControl: {
                    type: Boolean,
                    value: false
                },
                editedValue: {
                    type: String,
                    observer: '_onEditedValueChanged'
                },
                needNumberDelete: {
                    type: Boolean,
                    value: false
                },
                doneArray: {
                    type: Array,
                    value: () => []
                },
                noDelete: {
                    type: Boolean,
                    value: false
                },
                viewport: {
                    type: String,
                    value: 'Portrait'
                }
            }
        }

        constructor () {
            super();
            Polymer.RenderStatus.afterNextRender(this, () => {
                this.processApiStatements(Kano.Tapcode.api);
                //FIXME
                canvas = this.$.canvas;
                this._toggleFullscreen = this._toggleFullscreen.bind(this);
            });
        }
        
        connectedCallback () {
            this._onResize = this._onResize.bind(this);
            this._onResize();
            window.addEventListener('resize', this._onResize);
        }
        
        disconnectedCallback () {
            window.removeEventListener('resize', this._onResize);
        }
        
        _toggleFullscreen (event) {
            let fullscreenBtn = this.$['fullscreen-tap-area'],
                canvas = this.$.canvas,
                canvasRect,
                canvasToCentered,
                fullscreenBtnTop;
            this.fullscreen = !this.fullscreen;
            
            if (this.fullscreen) {
                canvasRect = canvas.getBoundingClientRect();
                canvasToCentered = Math.abs(window.innerHeight / 2 - canvasRect.height / 2 - canvasRect.top);
                canvas.style.transform = `translate(0, ${canvasToCentered}px)`;
                fullscreenBtnTop = fullscreenBtn.getBoundingClientRect().top;
                fullscreenBtn.style.transform = `translateY(-${fullscreenBtnTop}px)`;
            } else {
                fullscreenBtn.style.transform = `translateY(0)`;
                canvas.style.transform = `translate(0, 0)`;
            }

        }

        runCode (e) {
            if (this.CanvasDraw) {
                this.resetCanvas();
                this.CanvasDraw.runCode(e.detail);
            }
        }

        processApiStatements (statements) {
            let opts = {};
            opts.statements = Kano.Tapcode.api;
            opts.ctx = this.$.canvas.getContext("2d");
            opts.canvas = this.$.canvas;
            let canvasOpts = {};
            canvasOpts.ctx = this.$.canvas.getContext("2d");
            canvasOpts.canvas = this.$.canvas;
            this.CanvasDraw = new Kano.CanvasDraw(canvasOpts);
            this.prism = new Kano.Prism(opts);
            this.set('statements', this.prism.statements);
        }
  
        ready () {
            super.ready();
            Polymer.RenderStatus.afterNextRender(this, function() {
                this.resetCanvas();
            });
        }  
  
        _onEditRequest (e) {
            let dataType = e.detail.dataType || e.detail.returns;
            if (dataType) {
                this.inputType = this.activeTab = dataType;
            } else {
                this.inputType = 'newCode';
                this.activeTab = 'drawing';
            }
            this.$['menu-item-repeater'].render();
        }
  
        _addStatement (e) {
            if (this.whitelist && this.whitelist.indexOf(e.model.statement.name) === -1) {
                return;
            }
            this.$.editor.addCode(e.model.statement);
        }
  
        _processInput (e) {
            if (e.detail === 'done') {
                this.$.editor.concludeEdit();
            } else {
                this.$.editor.processInput(e.detail);
            }
        }
  
        _selectMenuTab (e) {
            this.activeTab = e.currentTarget.getAttribute('data-value');
            this.$['menu-item-repeater'].render();
        }
  
        _filterMenuItem (item) {
            if (this.inputType === 'newCode') {
                return item.type === this.activeTab;
            } else {
                return item.returns === this.inputType;
            }
        }
  
        _isEqual (selected, instance) {
            this.$['color-input'].notifyResize();
            return selected === instance;
        }

        exportCode () {
            let a = document.createElement('a'),
                file = new Blob([this.getCode()], {type: 'application/taptype'}),
                url = URL.createObjectURL(file);
            document.body.appendChild(a);
            a.download = 'my-code.tapcode';
            a.href = url;
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        }
        
        getCode () {
            return JSON.stringify(this.$.editor.lines);
        }

        _importCode () {
            this.fileInput = document.createElement('input');
            this.fileInput.setAttribute('type', 'file');
            this.fileInput.style.display = 'none';
            this.fileInput.addEventListener('change', evt => {
                let f = evt.target.files[0];
                if (f) {
                    let r = new FileReader();
                    r.onload = (e) => {
                        // Read the mode
                        let code = JSON.parse(e.target.result);
                        this.$.editor.set('lines', code);
                    };
                    r.readAsText(f);
                    document.body.removeChild(this.fileInput);
                }
            });
            document.body.appendChild(this.fileInput);
            this.fileInput.click();
        }
  
        _moveLeft () {
            this.$.editor.moveCursor(-1);
        }
  
        _moveRight () {
            this.$.editor.moveCursor(1);
        }

        _toggleOperator () {
            this.$.editor.toggleOperator(this.operator);
            this.operator = this.operator === '-' ? '+' : '-';
        }
  
        clearCode () {
            if (Kano.Tapcode.loop) {
                window.cancelAnimationFrame(Kano.Tapcode.loop);
                Kano.Tapcode.loop = null;
            }
            this.$.editor.reset();
            this.resetCanvas();
        }
        
        resetAndRun () {
            // this.resetCanvas();
            this.$.editor.runCode();
        }

        resetCanvas () {
            window.resetCanvas();
        }

        spliceValue () {
            //TODO refactor
            let ed = this.$.editor;
            let currentValue = ed.get(`lines.${ed.currentLine}.segments.${ed.currentSegment}.value`);
            if (currentValue.length > 1) {
                ed.set(`lines.${ed.currentLine}.segments.${ed.currentSegment}.value`, currentValue.slice(0, -1));
                this.editedValue = currentValue.slice(0, -1);
            } else {
                ed.set(`lines.${ed.currentLine}.segments.${ed.currentSegment}.value`, 0);
            }
        }

        _needNumberControl (activeTab, showNumberControl) {
            return activeTab === 'number' && showNumberControl;
        }

        _onEditedValueChanged (value) {
            this.showNumberControl = !isNaN(parseFloat(value));
            if (!isNaN(parseFloat(value))) {
                this.showNumberControl = true;
                this.needNumberDelete = value.length > 0;
                // this.needOperator = value !== '0';
                this.operator = value < 0 ? '+' : '-' 
            }
        }

        _needCodeTray (inputType, activeTab) {
            return (inputType === 'newCode' || activeTab === 'expressions');
        }

        _computeTabClass (activeTab, instance) {
            return activeTab === instance ? 'toolbox-tab flex selected' : 'toolbox-tab flex';
        }

        _calculateSegmentClass (type) {
            return `segment ${type}`;
        }
        
        _getEditorDimensions () {
            return {
                height: this.shadowRoot.querySelector('.code-and-canvas').getBoundingClientRect().height,   
                width: this.shadowRoot.querySelector('.code-and-canvas').getBoundingClientRect().width
            }
        }
        
        _onResize () {
            // TODO DEBOUNCE
            let codeArea =  this._getEditorDimensions(),
                size;
            
            // The canvas is a square and takes the size of the code workspace minus 8px margin
            // The available space has a portrait aspect ratio
            if (codeArea.height >= codeArea.width) {
                this.viewport = 'portrait';
                size = codeArea.width - 16;
                this.$.canvas.style.width = this.$.canvas.style.height = `${size}px`
                this.$.canvas.style.top = `${codeArea.height / 2 - (size / 2)}px`;
                this.$.canvas.style.left = `8px`;
             
            // It's landscape  
            } else {
                this.viewport = 'landscape';
                size = codeArea.height - 16;
                this.$.canvas.style.width = this.$.canvas.style.height = `${size}px`
                this.$.canvas.style.top = '8px';
                this.$.canvas.style.left = `${codeArea.width / 2 - (size / 2)}px`;
            }
            
            window.cursorX = Math.round(size / 2);
            window.cursorY = Math.round(size / 2);
        }

      }
      customElements.define(TapcodeIde.is, TapcodeIde);
    </script>

</dom-module>

